<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Regex to Tikz</title>
    <link rel="stylesheet" type="text/css" href="style.css"/>

    <script src="automaton.js"></script>
    <script src="tikzCreation.js"></script>
    <script src="autCanvas.js"></script>
    <script src="lib/jquery-1.11.3.min.js"></script>
    <script src="lib/jquery.mousewheel.min.js"></script>
    <!-- Bootstrap javascript and css-->
    <link rel="stylesheet" href="lib/bootstrap-3.3.6/css/bootstrap.min.css">
    <!--<link rel="stylesheet" href="lib/bootstrap-3.3.6/css/bootstrap-theme.min.css">-->
    <script src="lib/bootstrap-3.3.6/js/bootstrap.min.js"></script>

    <script type="text/javascript">
        var elemData = new Map(); // contains additional data for each id
        // initialization
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()

            elemData.set("nfa", {initialized:false, canvasCntrl:null});
            elemData.set("dfa", {initialized:false, canvasCntrl:null});
            elemData.set("minDfa", {initialized:false, canvasCntrl:null});
        });

        function submit() {
            var regex = $("#regex").val();
            try {
                var parser = new RegexParser(regex);
                console.log("Compiling regular expression to nfa");
                var nfa = parser.parse();
                console.log("Creating DFA");
                var dfa = nfa2dfa(nfa, parser.alphabet, $("#generateSink").is(":checked"));
                console.log("Minimizing DFA");
                var minDFA = minimize(dfa);

                $("#result").show();

                if ($("#showNFA").is(":checked")) {
                    console.log("Creating HTML elements for the nfa");
                    $("#nfaDiv").show();
                    fillResult($("#nfa"), nfa);
                } else {
                    $("#nfaDiv").hide();
                }

                if ($("#showDFA").is(":checked")) {
                    console.log("Creating HTML elements for the powerset dfa");
                    $("#dfaDiv").show();
                    fillResult($("#dfa"), dfa);
                } else {
                    $("#dfaDiv").hide();
                }


                console.log("Creating HTML elements for the minimal dfa");
                fillResult($("#minDfa"), minDFA);

                var alpha = [];
                parser.alphabet.forEach(function(symb) { alpha.push(symb) });
                $("#alphDisplay").text("{" + alpha.sort() + "}");
                $("#simpleRegexDisplay").text(parser.simpleInput);
            } catch (e) {
                console.log("An exception occured");
                console.log(e);
                console.log(e.stack);
            }
        }

        function revealElem(elem, anchor, showText, hideText) {
            if (elem.is(":visible")) {
                elem.hide();
                anchor.text(showText);
            } else {
                elem.show();
                anchor.text(hideText);
            }
        }


        function fillResult(elem, automaton) {
            var id = elem.attr("id");
            data = elemData.get(id);

            console.log(id);

            if (!data.initialized) {
                if (id != "minDfa") {// create the elements by cloning the min dfa prototype
                    var cloned = $("#minDfa").clone().attr("id", id);

                    // adjust ids and references
                    cloned.find("#latex_minDfa").attr("id", "latex_" + id);
                    cloned.find("#latextab_minDfa").attr("id", "latextab_"+id).attr("href", "#latex_"+id);

                    cloned.find("#structure_minDfa").attr("id", "structure_" + id);
                    cloned.find("#structuretab_minDfa").attr("id", "structuretab_"+id).attr("href", "#structure_"+id);

                    elem.replaceWith(cloned);
                    elem = cloned;
                }

                // initialize the controller for this automaton's canvas
                var canvas = elem.find("canvas");
                data.canvasCntrl = new CanvasController(canvas, automaton);

                // bind the function for the render button
                var renderBtn = elem.find(":button");
                var tikzDispl = elem.find("textarea");
                var renderImg = elem.find("img");
                renderBtn.click(function(event) {
                    console.log("clicked!");
                    fetchLatexRenderedPng(tikzDispl.val(), renderImg, renderBtn);
                });

                data.initialized = true;
            } else { // find all the (existing) elements
                tikzDispl = elem.find("textarea");
                renderImg = elem.find("img");
                renderBtn = elem.find("button");
            }

            // populate the element contents
            tikzDispl.val(convertToTikz(automaton));
            fetchLatexRenderedPng(tikzDispl.val(), renderImg, renderBtn);

            // update the canvas
            var cntrl = data.canvasCntrl;
            cntrl.automaton = automaton;
            cntrl.changelistener = function(state) {
                tikzDispl.val(generateCode(automaton));
            };

            cntrl.drawAutomaton();
        }

        function fetchLatexRenderedPng(tikz, img, button) {
            button.prop("disabled", true);
            img.attr("src", "loading.gif").attr("width", "128");

            $.ajax({
                url: encodeURI("render.php"),
                type: "POST",
                data: "tikz=" + tikz,
                mimeType: "text/plain; charset=x-user-defined",
                success: function (responseJSON) {
                    // parse response
                    var response = JSON.parse(responseJSON);
                    var width = Math.min(.9 * $("#result").width(), response["width"]);

                    // adjust DOM elements
                    button.prop("disabled", false);
                    img.attr("src", response["url"]).attr("width", width);
                },
                error: function (xhr, textStatus) {
                    img.attr("src", ""); // TODO some sort of error img or something
                    button.prop("disabled", false);
                    alert("Error " + xhr.status + ": " + xhr.statusText + ", " + textStatus);
                }
            });
        }
    </script>
</head>

<h1>Regex2Tikz</h1>
<em>A simple tool for converting a regular expression into TIKZ code for its corresponding automatons.</em>
<p>
<div class="group" id="input">
    <div id="inputInner">
        <div id="inputPrompt"><b>Start by inserting a regular expression.</b></div><br>
        <input type="text" id="regex" placeholder="e.g. (a|b)*c" autofocus class="inputElement" list="regexList"><br>
        <datalist id="regexList">
            <option value="abc"></option>
            <option value="(a|b)*c"></option>
            <option value="(a|b|c)*a(a|b|c)*b(a|b|c)*c(a|b|c)*"></option>
            <option value="(a|c)c* (a(a|c))*b(acc*a | c(ca*c)*a)"></option>
            <option value="(a|c)* a(a|c)* b(a|c)* c(a|c)* | (a|c)* c(a|c)* b(a|c)* a(a|c)*"></option>
            <option value="a?(bc)+de+(f(g|h))?"></option>
        </datalist>
        <input type="button" value="Generate Automaton" onclick="submit()" class="inputElement">
    </div>

    <hr width="75%">

    <span id="optionShowHide" class="linked" onclick="revealElem($('#options'), $('#optionShowHide'), 'Show options', 'Hide options');">Show options</span>

    <div hidden id="options"  style="text-align:left;">
        Symbol to use for the empty word: <input type="text" id="emptySymb" value="\varepsilon" list="emptyWordList"><br>
        <datalist id="emptyWordList">
            <option value="\varepsilon">&epsilon;</option>
            <option value="\epsilon">&#x3f5;</option>
            <option value="\lambda">&lambda;</option>
            <option value=" ">(Nothing)</option>
        </datalist>
    <span data-toggle="tooltip" data-placement="right" title="Specifiy a prefix to apply to each state label (e.g.,
    if you write 'q' then the states will be named q0, q1, ...)">
        State name prefix: <input type="text" id="statePrefix" value="">
    </span><br>
    <span data-toggle="tooltip" data-placement="right" title="Explicitly generate a sink state in deterministic
    automatons">
        <input type="checkbox" id="generateSink">Generate sink state
    </span><br>
    <span data-toggle="tooltip" data-placement="right" title="Generate the nondeterministic automaton that is directly
    generated from the regular expression">
        <input type="checkbox" id="showNFA" checked> Also show NFA
     </span><br>
    <span data-toggle="tooltip" data-placement="right" title="Generate the deterministic powerset automaton before the
    minimization process">
        <input type="checkbox" id="showDFA" checked> Also show non-minimal powerset DFA
    </span><br>
    </div>

    <hr width="75%">
</div>

<div hidden id="result" width="100%">
    <div class="group" id="nfaDiv">
        <h2 id="nfaHeader" class="linked"
            onclick="revealElem($('#innerNFA'), $('#nfaHeader'),'Resulting NFA &#x25BC;' ,'Resulting NFA &#x25B2;')">
            Resulting NFA &#x25BC;</h2>
        <div hidden id="nfa"></div></div>

    <div class="group" id="dfaDiv">
        <h2 id="dfaHeader" class="linked"
            onclick="revealElem($('#innerDFA'), $('#dfaHeader'),'Non-minimal powerset DFA &#x25BC;' ,'Non-minimal powerset DFA &#x25B2;')">
            Non-minimal powerset DFA &#x25BC;</h2>
        <div hidden id="dfa"></div></div>

    <div class="group" id="minDFADiv">
        <h2 id="minDFAHeader" class="linked"
            onclick="revealElem($('#innerMinDFA'), $('#minDFAHeader'),'Minimized DFA &#x25BC;' ,'Minimized DFA &#x25B2;')">
            Minimized DFA &#x25BC;</h2>

        <div id="minDfa">
            <textarea rows="20" cols="60" disabled></textarea>
            <ul class="nav nav-tabs">
                <li class="active">
                    <a href="#latex_minDfa" data-toggle="tab" id="latextab_minDfa">LaTeX - rendered</a>
                </li>
                <li>
                    <a href="#structure_minDfa" data-toggle="tab" id="structuretab_minDfa">Edit Structure</a>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane active" id="latex_minDfa">
                    <img src=""/> <br>
                    <input type="button" class="renderBtn" value="Render again...">
                </div>
                <div class="tab-pane" id="structure_minDfa">
                    <canvas width="500" height="500" class="stateCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <h4>Alphabet of the regular expression: <span id="alphDisplay"></span></h4>
    <h4>Simplified expression: <span id="simpleRegexDisplay"></span></h4>
</div>
</body>
</html>