<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Regex to Tikz</title>
    <link rel="stylesheet" type="text/css" href="style.css"/>

    <script src="automaton.js"></script>
    <script src="tikzCreation.js"></script>
    <script src="autCanvas.js"></script>
    <script src="lib/jquery-1.11.3.min.js"></script>

    <!-- Bootstrap javascript and css-->
    <link rel="stylesheet" href="lib/bootstrap-3.3.6/css/bootstrap.min.css">
    <script src="lib/bootstrap-3.3.6/js/bootstrap.min.js"></script>

    <script type="text/javascript">
        var elemData = new Map(); // contains additional data for each id
        // initialization
        $(function () {
            $('[data-toggle="tooltip"]').tooltip();

            elemData.set("nfa", {initialized:false, canvasCntrl:null});
            elemData.set("dfa", {initialized:false, canvasCntrl:null});
            elemData.set("minDfa", {initialized:false, canvasCntrl:null});

            $("#statePrefix").on("input", function(event) {
                var prefixEmpty = $("#statePrefix").val().trim() == "";
                $("#cbIndexSubscript").prop("disabled", prefixEmpty);
            });
        });

        function submit() {
            var regex = $("#regex").val();
            try {
                // parse the regex and create the automatons
                var parser = new RegexParser(regex);
                var nfa = parser.parse();
                var dfa = nfa2dfa(nfa, parser.alphabet, $("#generateSink").is(":checked"));
                var minDfa = minimize(dfa);

                // adjust the DOM to show the resulting automatons
                if ($("#showNFA").is(":checked")) {
                    $("#nfaDiv").show();
                    fillResult($("#nfa"), nfa);
                } else {
                    $("#nfaDiv").hide();
                }

                if ($("#showDFA").is(":checked")) {
                    $("#dfaDiv").show();
                    fillResult($("#dfa"), dfa);
                } else {
                    $("#dfaDiv").hide();
                }

                fillResult($("#minDfa"), minDfa);
                $("#result").show();

                if ( !$("#showNFA").is(":checked") && !($("showDFA").is(":checked")) ) {
//                    $("#minDfa").collapse("show");
                }

                // fill the statistics div
                var alpha = [];
                parser.alphabet.forEach(function(symb) { alpha.push(symb) });
                $("#statistics").show();
                $("#alphDisplay").text("{" + alpha.sort() + "}");
                $("#simpleRegexDisplay").text(parser.simpleInput);
                $("#origRegexDisplay").text(parser.origInput);
                $("#autSizeDisplay").text(minDfa.length);
                $("#btnUpdate").prop("disabled", false).click(function() {
                    renameStates(nfa); renameStates(minDfa); renameStates(dfa);
                    updateAutomatonNames(nfa, dfa, minDfa);
                });
            } catch (e) {
                console.log("An exception occurred");
                console.log(e);
                console.log(e.stack);
            }
        }

        function updateAutomatonNames(nfa, dfa, minDfa) {
            var elem, tikz;

            if ($("#showNFA").is(":checked")) {
                elem = $("#nfa");
                tikz = generateCode(nfa);
                elem.find("textarea").val(tikz);
                fetchLatexRenderedPng(tikz, elem.find("img"), elem.find("#btnRender"));
                elemData.get("nfa").canvasCntrl.drawAutomaton();
            }
            if ($("#showDFA").is(":checked")) {
                elem = $("#dfa");
                tikz = generateCode(dfa);
                elem.find("textarea").val(tikz);
                fetchLatexRenderedPng(tikz, elem.find("img"), elem.find("#btnRender"));
                elemData.get("dfa").canvasCntrl.drawAutomaton();
            }

            elem = $("#minDfa");
            tikz = generateCode(minDfa);
            elem.find("textarea").val(tikz);
            fetchLatexRenderedPng(tikz, elem.find("img"), elem.find("#btnRender"));
            elemData.get("minDfa").canvasCntrl.drawAutomaton();
        }

        function revealElem(elem, anchor, showText, hideText) {
            elem.collapse("toggle" );

            var arr = ["nfa", "dfa", "minDfa"];
            if (arr.indexOf(elem.attr("id")) > 0) {
                removeElem(arr, elem.attr("id"));
                for (var toHide of arr) {
                    var elemToHide = $("#" + toHide);
                    if (elemToHide.attr("aria-expanded") == "true") {
                        elemToHide.collapse("hide");
                        var header = $("#" + toHide + "Header");
                        header.text(header.text().replace("▲", "▼"));
                    }
                }
            }

            if (elem.attr("aria-expanded") == "true") {
                anchor.text(hideText);
            } else {
                anchor.text(showText);
            }

            window.scroll(0, elem.offset().top);
        }

        function fillResult(elem, automaton) {
            var id = elem.attr("id");
            var data = elemData.get(id);

            if (!data.initialized) {
                if (id != "minDfa") {// create the elements by cloning the min dfa prototype
                    var cloned = $("#minDfa").clone().attr("id", id);

                    // adjust ids and references
                    cloned.find("#tikz_minDfa").attr("id", "tikz_"+id);
                    cloned.find("#tikztab_minDfa").attr("id", "tikztab_"+id).attr("href", "#tikz_"+id);

                    cloned.find("#latex_minDfa").attr("id", "latex_" + id);
                    cloned.find("#latextab_minDfa").attr("id", "latextab_"+id).attr("href", "#latex_"+id);

                    cloned.find("#structure_minDfa").attr("id", "structure_" + id);
                    cloned.find("#structuretab_minDfa").attr("id", "structuretab_"+id).attr("href", "#structure_"+id);

                    elem.replaceWith(cloned);
                    elem = cloned;
                }

                // initialize the controller for this automaton's canvas
                var canvas = elem.find("canvas");
                data.canvasCntrl = new CanvasController(canvas, automaton, elem.find(".canvasControl"));

                // bind the function for the render button
                var renderBtn = elem.find("#btnRender");
                var tikzDispl = elem.find("textarea");
                var renderImg = elem.find("img");
                renderBtn.click(function(event) {
                    fetchLatexRenderedPng(tikzDispl.val(), renderImg, renderBtn);
                });

                elem.find("#btnClipboard").click(function() {
                    tikzDispl.select();
                    document.execCommand("copy");

                    if (window.getSelection) {
                        if (window.getSelection().empty) {  // Chrome
                            window.getSelection().empty();
                        } else if (window.getSelection().removeAllRanges) {  // Firefox
                            window.getSelection().removeAllRanges();
                        }
                    } else if (document.selection) {  // IE?
                        document.selection.empty();
                    }
                });

                data.initialized = true;
            } else { // find all the (existing) elements
                tikzDispl = elem.find("textarea");
                renderImg = elem.find("img");
                renderBtn = elem.find("#btnRender");
            }

            // populate the element contents
            tikzDispl.val(convertToTikz(automaton));
            fetchLatexRenderedPng(tikzDispl.val(), renderImg, renderBtn);

            // update the canvas
            var cntrl = data.canvasCntrl;
            cntrl.loadAutomaton(automaton);
            cntrl.changelistener = function(state) {
                tikzDispl.val(generateCode(automaton));
            };

            cntrl.drawAutomaton();
        }

        function fetchLatexRenderedPng(tikz, img, button) {
            button.prop("disabled", true);
            img.attr("src", "img/loading.gif").attr("width", "128");

            $.ajax({
                url: encodeURI("render.php"),
                type: "POST",
                data: "tikz=" + tikz,
                mimeType: "text/plain; charset=x-user-defined",
                success: function (responseJSON) {
                    // parse response
                    var response = JSON.parse(responseJSON);
                    var width = Math.min(.9 * $("#result").width(), response["width"]);

                    // adjust DOM elements
                    button.prop("disabled", false);
                    img.attr("src", response["url"]).attr("width", width);
                },
                error: function (xhr, textStatus) {
                    img.attr("src", ""); // TODO some sort of error img or something
                    button.prop("disabled", false);
                    alert("Error " + xhr.status + ": " + xhr.statusText + ", " + textStatus);
                }
            });
        }
    </script>
</head>



<body>
<h1>Regex<em>2</em>Ti<em>k</em>Z</h1>
<p>
<em>A simple tool for converting a regular expression into Ti<em>k</em>Z code for the corresponding automaton.</em>
</p>
<div class="group" id="input">
    <div id="inputInner">
        <div id="inputPrompt"><b>Start by inserting a regular expression.</b></div>
        <input type="text" id="regex" placeholder="(a|b)*c" autofocus class="inputElement" list="regexList">
        <input type="button" value="Generate Automaton" onclick="submit()" class="inputElement">
    </div>

    <hr width="75%" class="split1">

    <b id="optionShowHide" class="spoilerLink"
          onclick="revealElem($('#options'), $('#optionShowHide'), '[+] Show options', '[-] Hide options');">
        [+] Show options
    </b>

    <div id="options" class="collapse left">
        <table><tbody>
            <tr>
                <td class="left">Symbol to use for the empty word: </td>
                <td class="left" colspan="2"><input type="text" id="emptySymb" value="\varepsilon" list="emptyWordList"></td>
            </tr>
            <tr data-toggle="tooltip" data-placement="right" title="Specifiy a prefix to apply to each state label (e.g.,
    if you write 'q' then the states will be named q0, q1, ...)">
                <td class="left">State name prefix: </td>
                <td class="left"><input type="text" id="statePrefix" value=""></td>
                <td class="left">
                    <input type="checkbox" id="cbIndexSubscript" disabled checked>
                    <label for="cbIndexSubscript">Index as subscript</label>
                </td>
            </tr>
            <tr>
                <td class="left">Start numbering at: </td>
                <td class="left" colspan="2"><input type="number" id="numberStart" value="0"></td>
            </tr>
            <tr>
                <td colspan="3">
                    <button type="button" class="btn btn-primary" style="width:40%; margin-top:5px !important"
                            disabled id="btnUpdate">Update automaton</button>
                </td>
            </tr>
            <tr>
                <td style="padding-top:15px !important" class="left" colspan="1">
                    <input type="checkbox" id="showNFA">
                    <label for="showNFA">Also show NFA</label>
                </td>
                <td style="padding-top:15px !important" class="left" colspan="2">
                    <input type="checkbox" id="showDFA">
                    <label for="showDFA">Also show non-minimal powerset DFA</label>
                </td>
            </tr>
            <tr>
                <td class="left" colspan="3"><label><input type="checkbox" id="generateSink">Generate sink state</label></td>
            </tr>
        </tbody></table>
    </div>

    <hr width="75%" class="split1">
</div>
<div hidden id="statistics" class="group" style="text-align:center">
    <h4>Info</h4>
    <hr width="50%" class="split1">
    <table style="margin-bottom:5px">
        <tr>
            <td class="left">Original expression: </td>
            <td id="origRegexDisplay" class="left"></td>
        </tr>
        <tr>
            <td class="left">Simplified expression: </td>
            <td id="simpleRegexDisplay" class="left"></td>
        </tr>
        <tr>
            <td class="left">Alphabet: </td>
            <td id="alphDisplay" class="left"></td>
        </tr>
        <tr>
            <td class="left">Size of the minimal automaton: </td>
            <td class="left"> <span id="autSizeDisplay"></span> states</td>
        </tr>
    </table>
</div>
<div hidden id="result">
    <div class="group" id="nfaDiv">
        <h2 id="nfaHeader" class="spoilerLink"
            onclick="revealElem($('#nfa'), $('#nfaHeader'),'Resulting NFA &#x25BC;' ,'Resulting NFA &#x25B2;')">
            Resulting NFA &#x25BC;</h2>
        <div id="nfa" class="collapse"></div></div>

    <div class="group" id="dfaDiv">
        <h2 id="dfaHeader" class="spoilerLink"
            onclick="revealElem($('#dfa'), $('#dfaHeader'),'Non-minimal powerset DFA &#x25BC;' ,'Non-minimal powerset DFA &#x25B2;')">
            Non-minimal powerset DFA &#x25BC;</h2>
        <div id="dfa" class="collapse"></div></div>

    <div class="group" id="minDfaDiv">
        <h2 id="minDfaHeader" class="spoilerLink"
            onclick="revealElem($('#minDfa'), $('#minDfaHeader'),'Minimized DFA &#x25BC;' ,'Minimized DFA &#x25B2;')">
            Minimized DFA &#x25BC;</h2>

        <div id="minDfa" class="collapse">
            <hr width="90%">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a href="#tikz_minDfa" data-toggle="tab" id="tikztab_minDfa">Ti<em>k</em>Z Code</a>
                </li>
                <li>
                    <a href="#latex_minDfa" data-toggle="tab" id="latextab_minDfa">LaTeX: Preview</a>
                </li>
                <li>
                    <a href="#structure_minDfa" data-toggle="tab" id="structuretab_minDfa">Editor</a>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane active" id="tikz_minDfa">
                    <textarea rows="20" cols="60" class="autDisplay" onclick="this.focus(); this.select();"></textarea><br>
                    <button type="button" class="btn btn-primary" id="btnClipboard">Copy to clipboard</button>
                </div>
                <div class="tab-pane" id="latex_minDfa">
                    <img src="" class="autDisplay"/> <br>
                    <button type="button" class="btn btn-primary" id="btnRender">Render again...</button><br>
                    <span style="font-size: smaller;margin-top:5px">LaTeX-rendering powered by <a href="http://www.quicklatex.com" target="_blank">quicklatex.com</a>.</span>
                </div>
                <div class="tab-pane" id="structure_minDfa">
                    <div class="canvasControl">
                        <table><tbody><tr>
                        <td><label><input type="checkbox" id="cbGrid"> Show Grid</label></td>
                        <td><button type="button" class="btn btn-default" id="btnZoomIn">+</button>
                        <button type="button" class="btn btn-default" id="btnZoomOut">-</button></td>
                        <td><button type="button" class="btn btn-default" id="btnCenter">Center</button>
                        <button type="button" class="btn btn-default" id="btnAlign">Align to grid</button></td>
                        <td><label>Snap to <select id="slSnap">
                            <option value="grid">Grid</option>
                            <option value="neighbour">Neighbour</option>
                            <option value="none">Nothing</option>
                        </select></label></td>
                        </tr></tbody></table>
                    </div>
                    <hr class="split2">
                    <canvas width="500" height="500" class="stateCanvas autDisplay"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>
<!-- datalists -->
<datalist id="emptyWordList">
    <option value="\varepsilon">&epsilon;</option>
    <option value="\epsilon">&#x3f5;</option>
    <option value="\lambda">&lambda;</option>
    <option value=" ">(Nothing)</option>
</datalist>
<datalist id="regexList">
    <option value="abc"></option>
    <option value="(a|b)*c"></option>
    <option value="(a|b|c)*a(a|b|c)*b(a|b|c)*c(a|b|c)*"></option>
    <option value="(a|c)c* (a(a|c))*b(acc*a | c(ca*c)*a)"></option>
    <option value="(a|c)* a(a|c)* b(a|c)* c(a|c)* | (a|c)* c(a|c)* b(a|c)* a(a|c)*"></option>
    <option value="a?(bc)+de+(f(g|h))?"></option>
</datalist>
</body>
</html>