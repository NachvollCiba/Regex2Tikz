<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Regex to Tikz</title>
    <script src="automaton.js"></script>
    <script src="tikzCreation.js"></script>
    <script src="lib/jquery-1.11.3.min.js"></script>
    <script type="text/javascript">
        function submit() {
            var regex = $("#regex").val();
            try {
                var parser = new RegexParser(regex);
                var nfa = parser.parse();

                var tikz = convertToTikz(nfa);

                $("#result").show();
                $("#alphDisplay").text(parser.alphabet);

                $("#resultTikzNFA").val(tikz);
                $("#resultImgNFA").attr("src", "loading.gif");

                var canvas = document.getElementById("drawCanvasNFA");
                drawAutomaton(nfa, canvas);

                $.ajax({
                    url: encodeURI("render.php"),
                    type: "POST",
                    data: "tikz=" + tikz,
                    success: function (data) {
                        var img = "data:image/png;base64," + data;
                        $("#resultImgNFA").attr("src", img);
                        $("#resultTikzNFA").append(img);
                    },
                    error: function (xhr, textStatus) {
                        $("#resultImgNFA").attr("src", "");
                        alert("Error " + xhr.status + ": " + xhr.statusText + ", " + textStatus);
                    }
                });

                var dfa = nfa2dfa(nfa, parser.alphabet);
                tikz = convertToTikz(dfa);

                $("#resultTikzDFA").val(tikz);
                $("#resultImgDFA").attr("src", "loading.gif");

                canvas = document.getElementById("drawCanvasNFA");
                drawAutomaton(dfa, canvas);

                $.ajax({
                    url: encodeURI("render.php"),
                    type: "POST",
                    data: "tikz=" + tikz,
                    success: function (data) {
                        var img = "data:image/png;base64," + data;
                        $("#resultImgDFA").attr("src", img);
                        $("#resultTikzDFA").append(img);
                    },
                    error: function (xhr, textStatus) {
                        $("#resultImgDFA").attr("src", "");
                        alert("Error " + xhr.status + ": " + xhr.statusText + ", " + textStatus);
                    }
                });


            } catch (e) {
                $("#resultTikzNFA").val(e.stack).show();
            }
        }

        function drawAutomaton(nfa, canvas) {
            var ctx = canvas.getContext("2d");

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            var zoom = 40;

            const offsetX = canvas.width / 2;
            const offsetY = canvas.height / 2;

            const stateDia = .4 * zoom;
            const stateRad = stateDia / 2;

            for (var i = 0; i < nfa.length; i++) {
                var state = nfa[i];
                var posX = state.position[0] * zoom + offsetX;
                var posY = -state.position[1] * zoom + offsetY;

                ctx.beginPath();
                ctx.arc(posX, posY, stateDia, 0, 2 * Math.PI);
                ctx.stroke();
                ctx.moveTo(posX, posY);
                ctx.fillText(state.name, posX, posY);

                for (var symb in state.transitions) {
                    var nextStates = state.transitions[symb];

                    for (var j = 0; j < nextStates.length; j++) {
                        var otherX = nextStates[j].position[0] * zoom + offsetX;
                        var otherY = -nextStates[j].position[1] * zoom + offsetY;

                        var dirX = otherX > posX ? 1 : -1;
                        var dirY = otherY > posY ? 1 : -1;

                        ctx.moveTo(posX, posY);
                        ctx.lineTo(otherX, otherY);
                        ctx.stroke();

                        var midX = (posX + (otherX - posX) / 2);
                        var midY = (posY + (otherY - posY) / 2);
                        ctx.moveTo(midX, midY);
                        symb = symb == EPS ? "â‚¬" : symb;
                        ctx.fillText(symb, midX, midY);
                    }
                }

            }
        }
    </script>
</head>
<body style="text-align: center">
<h2>Insert a regular expression</h2>
<input type="text" id="regex" placeholder="e.g. (a|b)*c" autofocus="true">
<input type="button" value="Generate Automaton" onclick="submit()">

<div hidden id="result">
    <h4>Alphabet of the regular expression: <span id="alphDisplay"></span></h4>
    <h2>Resulting NFA</h2>
    <h3>TIKZ Code</h3>
    <textarea rows="20" cols="50" id="resultTikzNFA" disabled></textarea><br>
    <canvas id="drawCanvasNFA" width="500" height="500"></canvas>

    <h3>LATEX-Rendered</h3>
    <img src="" id="resultImgNFA"/>

    <h2>Non-minimal powerset DFA</h2>
    <h3>TIKZ Code</h3>
    <textarea rows="20" cols="50" id="resultTikzDFA" disabled></textarea><br>
    <canvas id="drawCanvasDFA" width="500" height="500"></canvas>

    <h3>LATEX-Rendered</h3>
    <img src="" id="resultImgDFA"/>
</div>

</body>
</html>